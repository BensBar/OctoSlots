<html lang="en"><head>
  <!-- Set the character encoding for the document -->
  <meta charset="UTF-8">
  <!-- Make the page responsive on all devices with iPhone safe area support -->
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <!-- iPhone-specific meta tags for better mobile experience -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="OctoSlots">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="theme-color" content="#000000">
  <!-- Page title -->
  <title>OctoSlots 4K Edition</title>
  <!-- CSS styles for the slot machine game -->
  <style>
    /* iPhone 16 Pro Max (and similar large phones) optimization */
    @media (max-width: 450px) and (min-height: 800px) {
      html, body {
        width: 100vw;
        min-height: 100vh;
        max-width: 100vw;
        overflow-x: hidden;
        font-size: 18px;
      }
      .container {
        padding-top: 1.2rem;
        gap: 0.5rem;
      }
      .slot-arch-frame {
        width: 100vw;
        min-width: 0;
        padding: 0 0.2rem 7rem 0.2rem;
        box-sizing: border-box;
      }
      .slot-arch-top {
        width: 100vw;
        min-width: 0;
        box-sizing: border-box;
      }
      .slot-base {
        width: 100vw;
        min-width: 0;
        gap: 0.3rem;
        padding: 0 0.1rem;
        box-sizing: border-box;
      }
      .reels {
        width: 100vw;
        min-width: 0;
        gap: 0;
        padding: 0 0.1rem;
        box-sizing: border-box;
      }
      .reel {
        min-width: 0;
        margin: 0;
      }
      .reel-strip {
        min-width: 0;
      }
      .symbol {
        height: 5.2rem;
        min-width: 0;
      }
      .symbol img {
        max-height: 4.2rem;
        max-width: 90vw;
      }
      .pay-table {
        font-size: 1.05rem;
        padding: 0.2rem 0.1rem;
        width: 98vw;
        max-width: 98vw;
      }
      .pay-symbol {
        width: 1.2rem;
        height: 1.2rem;
      }
      .spin-btn, #spin-btn {
        font-size: 1.3rem;
        padding: 0.7rem 2.2rem;
        border-radius: 1.5rem;
        margin: 0.7rem 0 0.2rem 0;
        width: 90vw;
        max-width: 90vw;
      }
      .toggle-mode {
        font-size: 1rem;
        padding: 0.5rem 1.2rem;
        border-radius: 1rem;
        margin: 0.5rem 0 0.2rem 0;
      }
      .slot-arch-lights, .slot-arch-lights-bottom {
        width: 95vw;
        gap: 0.3rem;
      }
      .slot-arch-title-arc svg {
        height: 48px;
      }
    }
    /* Default color variables for enhanced 4K experience */
    :root {
      --bg-color: #fff;
      --text-color: #222;
      --border-color: #FFD700;
      --slot-bg: linear-gradient(145deg, #f8f4e6 0%, #ede4d3 50%, #e8dcc6 100%);
      --button-bg: linear-gradient(145deg, #FFD700 0%, #FFA500 50%, #FF8C00 100%);
      --button-color: #fff;
      --reel-glow: 0 0 40px 12px #FFD70066, 0 0 80px 20px #FF850033;
      --reel-radius: 3rem;
      --symbol-size: 8rem;
      --symbol-gap: 0;
      --reel-drum: linear-gradient(180deg, #fff9 0%, #fff 30%, #fffb 70%, #fff9 100%), 
                   radial-gradient(ellipse at 50% 30%, #FFD70033 0%, transparent 70%), 
                   linear-gradient(145deg, #f8f4e6 0%, #ede4d3 50%, #e8dcc6 100%);
      --reel-shadow: 0 0 40px 12px #FFD70044, 0 0 0 12px #fff4 inset, 0 0 60px 8px #FF850022;
      --bg-gradient: linear-gradient(135deg, #fffef7 0%, #fdf8e7 25%, #f8f4e6 50%, #f0e6d2 75%, #e8dcc6 100%);
      --machine-bg: linear-gradient(180deg, #f5f5f5 0%, #e8e8e8 50%, #d5d5d5 100%);
      --arch-bg: linear-gradient(145deg, #ffffff 0%, #f8f8f8 50%, #f0f0f0 100%);
      --paytable-bg: linear-gradient(145deg, #ffffff 0%, #fafafa 100%);
      --paytable-color: #333;
      --sparkle-color: #FFD700;
      --win-glow: 0 0 60px #FFD700, 0 0 120px #FFA500;
    }
    body:not(.light) {
      --bg-color: #000;
      --text-color: #fff;
      --border-color: #FFD700;
      --slot-bg: linear-gradient(145deg, #2a2a2a 0%, #1f1f1f 50%, #1a1a1a 100%);
      --button-bg: linear-gradient(145deg, #e53935 0%, #d32f2f 50%, #b71c1c 100%);
      --button-color: #fff;
      --reel-glow: 0 0 50px 15px #FFD70088, 0 0 100px 25px #FF850044;
      --reel-drum: linear-gradient(180deg, #333a 0%, #222 30%, #111b 70%, #333a 100%), 
                   radial-gradient(ellipse at 50% 30%, #FFD70044 0%, transparent 70%), 
                   linear-gradient(145deg, #2a2a2a 0%, #1f1f1f 50%, #1a1a1a 100%);
      --bg-gradient: linear-gradient(135deg, #000000 0%, #1a1a1a 25%, #2a2a2a 50%, #1f1f1f 75%, #000000 100%);
      --machine-bg: linear-gradient(180deg, #1a1a1a 0%, #0f0f0f 50%, #000000 100%);
      --arch-bg: linear-gradient(145deg, #2a2a2a 0%, #1f1f1f 50%, #1a1a1a 100%);
      --paytable-bg: linear-gradient(145deg, #1a1a1a 0%, #222222 100%);
      --paytable-color: #fff;
      --sparkle-color: #FFD700;
      --win-glow: 0 0 80px #FFD700, 0 0 160px #FFA500;
    }
    .slot-arch-frame {
      background: var(--machine-bg) !important;
    }
    .slot-arch-top {
      background: var(--arch-bg) !important;
      background-image: none !important;
    }
    .slot-base {
      background: var(--arch-bg) !important;
    }
    body {
      background: var(--bg-gradient);
      color: var(--text-color);
    }
    .slot-arch-frame {
      background: var(--machine-bg);
    }
    .slot-arch-top {
      background: var(--arch-bg);
      background-image: none;
    }
    .slot-base {
      background: var(--arch-bg);
    }
    .pay-table {
      background: var(--paytable-bg);
      color: var(--paytable-color);
      box-shadow: 0 2px 8px #0002, 0 0 0 2px #fff8 inset;
      margin: 1.2rem auto 0 auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 0.3rem;
      border-radius: 1.2rem;
      padding: 0.5rem 0.7rem;
      max-width: 98vw;
      font-size: 0.98rem;
      align-items: flex-start;
      width: 100%;
      min-width: 0;
    }
    .pay-row {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-weight: 600;
      color: inherit;
      letter-spacing: 0.04em;
      margin: 0 0.1rem;
      flex-wrap: wrap;
    }
    .pay-symbol {
      width: 1.3rem;
      height: 1.3rem;
      object-fit: contain;
      filter: drop-shadow(0 1px 2px #0003);
      border-radius: 0.3rem;
      background: #fff;
      margin-right: 0.1rem;
      flex-shrink: 0;
    }
    .pay-label {
      color: inherit;
      font-size: 0.98rem;
      font-weight: 500;
      margin-right: 0.1rem;
      white-space: nowrap;
    }
    .pay-mult {
      color: #bfa100;
      font-size: 1rem;
      font-weight: 700;
      margin-left: 0.1rem;
      text-shadow: 0 0 4px #fff, 0 0 8px #ffd700;
      white-space: nowrap;
    }
    body:not(.light) .pay-mult {
      color: #e53935;
      text-shadow: 0 0 4px #fff, 0 0 8px #e53935;
    }
    @media (max-width: 600px) {
      .pay-table {
        padding: 0.4rem 0.2rem;
        font-size: 0.92rem;
      }
      .pay-symbol {
        width: 1.1rem;
        height: 1.1rem;
      }
      .pay-label, .pay-mult {
        font-size: 0.92rem;
      }
    }

    /* Main body styles with improved iPhone safe area handling */
    html, body {
      margin: 0;
      height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      /* Enhanced safe area support for iPhones */
      padding-top: calc(env(safe-area-inset-top) + 33vh);
      padding-bottom: env(safe-area-inset-bottom);
      padding-left: env(safe-area-inset-left);
      padding-right: env(safe-area-inset-right);
    }
    
    body {
      background: var(--bg-gradient);
      font-family: 'Segoe UI', 'Arial', 'Helvetica Neue', Arial, sans-serif;
      overflow: hidden;
      color: var(--text-color);
      background-size: 200% 200%;
      animation: bgmove 18s ease-in-out infinite;
    }

    /* Enhanced 4K particle effects and animations */
    @keyframes sparkle {
      0% { 
        opacity: 0; 
        transform: scale(0) rotate(0deg); 
      }
      50% { 
        opacity: 1; 
        transform: scale(1.2) rotate(180deg); 
      }
      100% { 
        opacity: 0; 
        transform: scale(0) rotate(360deg); 
      }
    }
    
    @keyframes pulse {
      0%, 100% { 
        transform: scale(1); 
        opacity: 1; 
      }
      50% { 
        transform: scale(1.1); 
        opacity: 0.8; 
      }
    }
    
    @keyframes winGlow {
      0%, 100% { 
        box-shadow: var(--win-glow); 
      }
      50% { 
        box-shadow: var(--win-glow), 0 0 200px #FFD700; 
      }
    }
    
    .sparkle {
      position: fixed;
      width: 20px;
      height: 20px;
      background: radial-gradient(circle, var(--sparkle-color) 0%, transparent 70%);
      border-radius: 50%;
      pointer-events: none;
      animation: sparkle 1.5s ease-out forwards;
      z-index: 1000;
    }
    
    .sparkle::before {
      content: 'âœ¨';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 16px;
      animation: pulse 0.5s ease-in-out infinite alternate;
    }
    
    .win-effect {
      animation: winGlow 2s ease-in-out infinite;
    }
    
    .reel.winning {
      animation: pulse 1s ease-in-out infinite;
      box-shadow: var(--win-glow), var(--reel-shadow);
    }
    /* Container for all game content */
    .container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      box-sizing: border-box;
    }
    /* Remove old .header, add arched title and emoji styles */
    .slot-arch-title-arc {
      width: 100%;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start;
      margin-top: -1.2rem; /* Raise the whole title/emoji group */
      margin-bottom: 0.2rem;
      position: relative;
      z-index: 3;
    }
    .slot-arch-title-arc svg {
      width: 100%;
      height: 80px;
      overflow: visible;
      margin-bottom: -0.7rem;
    }
    .slot-arch-title-arc text {
      font-family: 'Segoe UI', 'Arial', 'Helvetica Neue', Arial, sans-serif;
      text-shadow: 0 0 16px #fff, 0 0 32px #b71c1c;
    }
    .slot-arch-emoji {
      font-size: 3.2rem;
      color: #fff;
      text-shadow: 0 0 16px #fff, 0 0 32px #b71c1c;
      margin-top: -0.2rem;
      margin-bottom: 0.2rem;
      text-align: center;
      width: 100%;
      pointer-events: none;
    }
    .slot-arch-label {
      font-size: 1.5rem;
      color: #fff;
      text-shadow: 0 0 8px #b71c1c, 0 0 16px #fff;
      font-weight: 600;
      margin-top: 0.1rem;
      letter-spacing: 0.12em;
      text-align: center;
      pointer-events: none;
    }

    /* Button to toggle light/dark mode - moved to bottom */
    .toggle-mode {
      background: var(--button-bg);
      color: var(--button-color);
      border: none;
      padding: 0.5rem 1rem;
      border-radius: 0.8rem;
      cursor: pointer;
      font-size: 0.9rem;
      box-shadow: 0 2px 8px #0004;
      transition: background 0.2s;
    }
    .toggle-mode:hover {
      background: #b71c1c;
    }
    
    /* Footer container for toggle button and color picker */
    .toggle-mode-footer {
      text-align: center;
      padding: 1rem 0;
      margin-top: 1rem;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 1rem;
    }
    
    /* Color customization controls */
    .color-customization {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: rgba(0, 0, 0, 0.2);
      padding: 0.5rem 1rem;
      border-radius: 1rem;
      border: 1px solid rgba(255, 215, 0, 0.3);
    }
    
    .color-label {
      color: var(--text-color);
      font-size: 0.9rem;
      font-weight: 600;
    }
    
    .color-picker {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      background: none;
      padding: 0;
      outline: 2px solid rgba(255, 215, 0, 0.5);
      outline-offset: 2px;
      transition: outline-color 0.3s;
    }
    
    .color-picker:hover {
      outline-color: rgba(255, 215, 0, 0.8);
    }
    
    .color-picker::-webkit-color-swatch-wrapper {
      padding: 0;
      border-radius: 50%;
      border: none;
    }
    
    .color-picker::-webkit-color-swatch {
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    
    .color-picker::-moz-color-swatch {
      border: none;
      border-radius: 50%;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
    }
    /* Slot machine reels container */
    .reels {
      display: flex;
      overflow: visible;
      height: 24rem;
      width: 36rem;
      max-width: 95vw;
      border: 6px solid #bfa100;
      border-radius: var(--reel-radius);
      box-shadow: 0 0 64px 16px #FFD70055, 0 0 0 12px #fff2 inset, 0 8px 32px #000a, 0 0 0 8px #fff4 inset;
      background: var(--reels-bg, var(--slot-bg));
      position: relative;
      margin-bottom: 2rem;
      border-top: 10px solid #fff8;
      border-bottom: 10px solid #fff8;
    }
    /* Slot machine handle */
    .slot-handle {
      position: absolute;
      right: -3.5rem;
      top: 2.5rem; /* Move handle to top of lever */
      transform: none;
      width: 2.2rem;
      height: 10rem;
      background: linear-gradient(90deg, #bbb 0%, #fff 60%, #bbb 100%);
      border-radius: 1.2rem;
      box-shadow: 2px 0 12px #0006;
      z-index: 30;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-start; /* knob at top */
      transition: top 0.3s cubic-bezier(.4,2,.6,1), transform 0.3s cubic-bezier(.4,2,.6,1);
    }
    .slot-handle.pulled {
      top: 7.5rem; /* Animate handle down when pulled */
    }
    .slot-handle-knob {
      width: 2.7rem;
      height: 2.7rem;
      background: radial-gradient(circle at 60% 40%, #fff 0%, #e53935 60%, #b71c1c 100%);
      border-radius: 50%;
      box-shadow: 0 0 16px 4px #e5393588, 0 2px 8px #0006;
      margin-top: -1.2rem;
      border: 3px solid #fff8;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }
    .slot-handle-knob:active {
      box-shadow: 0 0 32px 8px #e53935cc, 0 2px 8px #0006;
    }
    /* Individual reel styles - Enhanced 4K */
    .reel {
      flex: 1;
      overflow: hidden;
      position: relative;
      border: 3px solid transparent;
      border-image: linear-gradient(145deg, #FFD700, #FFA500, #FF8C00) 1;
      border-radius: var(--reel-radius);
      margin: 0;
      background: var(--reel-drum);
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      box-shadow: var(--reel-shadow);
      position: relative;
    }
    
    .reel::before {
      content: '';
      position: absolute;
      top: -3px;
      left: -3px;
      right: -3px;
      bottom: -3px;
      background: linear-gradient(145deg, #FFD700, #FFA500, #FF8C00);
      border-radius: var(--reel-radius);
      z-index: -1;
      opacity: 0.8;
    }
    
    .reel.spinning {
      box-shadow: var(--reel-glow), var(--reel-shadow);
      transform: scale(1.02);
    }
    
    .reel:last-child {
      box-shadow: var(--reel-shadow);
    }
    /* The strip of symbols inside each reel */
    .reel-strip {
      position: absolute;
      top: 0;
      width: 100%;
      left: 0;
      will-change: transform;
      transition: filter 0.2s;
    }
    /* Enhanced symbol styles for 4K */
    .symbol {
      height: var(--symbol-size);
      display: flex;
      align-items: center;
      justify-content: center;
      margin: var(--symbol-gap) 0;
      filter: none;
      background: none;
      border: none;
      border-radius: 0;
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
    }
    
    .symbol::before {
      display: none;
    }
    
    .symbol:hover::before {
      display: none;
    }
    
    /* Enhanced symbol image styles */
    .symbol img {
      max-height: var(--symbol-size);
      max-width: 100%;
      width: 100%;
      height: 100%;
      object-fit: contain;
      image-rendering: -webkit-optimize-contrast;
      image-rendering: crisp-edges;
      border-radius: 0 !important;
      background: none !important;
      box-shadow: none !important;
      border: none !important;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      display: block;
    }
    
    .symbol img:hover {
      transform: none;
      box-shadow: none !important;
      border: none !important;
    }
    
    .symbol img:active {
      transform: scale(0.95);
    }
    /* Controls section (spin button) */
    .controls {
      margin-top: 1.5rem;
      margin-bottom: 1.5rem;
    }
    /* Enhanced 4K Spin button styles */
    button.spin {
      font-size: 2.5rem;
      padding: 0.8em 3em;
      background: linear-gradient(145deg, #FFD700 0%, #FFA500 25%, #FF8C00 50%, #FFA500 75%, #FFD700 100%);
      background-size: 200% 200%;
      color: #fff;
      border: none;
      border-radius: 2rem;
      box-shadow: 0 8px 32px rgba(255,215,0,0.4), 
                  0 4px 16px rgba(255,140,0,0.3),
                  0 0 0 3px rgba(255,255,255,0.2) inset;
      cursor: pointer;
      font-weight: 900;
      letter-spacing: 0.2em;
      text-shadow: 0 2px 4px rgba(0,0,0,0.3);
      transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
      position: relative;
      overflow: hidden;
      text-transform: uppercase;
    }
    
    button.spin::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
      transition: left 0.6s ease;
    }
    
    button.spin:hover {
      background-position: 100% 100%;
      transform: translateY(-2px) scale(1.05);
      box-shadow: 0 12px 48px rgba(255,215,0,0.6), 
                  0 6px 24px rgba(255,140,0,0.4),
                  0 0 0 4px rgba(255,255,255,0.3) inset;
    }
    
    button.spin:hover::before {
      left: 100%;
    }
    
    button.spin:active {
      transform: translateY(1px) scale(0.98);
      box-shadow: 0 4px 16px rgba(255,215,0,0.4), 
                  0 2px 8px rgba(255,140,0,0.3),
                  0 0 0 2px rgba(255,255,255,0.2) inset;
    }
    
    button.spin:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      background: linear-gradient(145deg, #999 0%, #666 50%, #444 100%);
    }
    /* Jackpot display styles */
    .jackpot {
      margin-top: 1.5rem;
      font-size: 1.3rem;
      color: var(--jackpot-color, var(--border-color));
      text-shadow: 0 0 8px #ffd70088;
      font-weight: 600;
      letter-spacing: 0.05em;
      background: #222a;
      border-radius: 1rem;
      padding: 0.5rem 1.5rem;
      box-shadow: 0 2px 8px #0004;
      display: inline-block;
    }
    body.light .jackpot {
      --jackpot-color: #fff;
      background: #bfa100;
      text-shadow: 0 0 8px #fff, 0 0 16px #bfa100;
    }
    /* Sparkle effect for win animation */
    .sparkle {
      position: absolute;
      width: 10px;
      height: 10px;
      background: gold;
      border-radius: 50%;
      animation: sparkle 1s ease-out forwards;
    }
    /* Animation for sparkles */
    @keyframes sparkle {
      0% { opacity: 1; transform: scale(1); }
      100% { opacity: 0; transform: scale(3) translateY(-50px); }
    }
  
    /* Gold line that appears on win */
    /* Win line: perfectly centered, with animated glowing effect */
    .win-line {
      position: absolute;
      top: 50%;
      left: 0;
      width: 100%;
      height: 0.5rem;
      background: linear-gradient(90deg, #fff6 0%, gold 50%, #fff6 100%);
      box-shadow: 0 0 8px 2px gold, 0 0 16px 4px orange;
      z-index: 10;
      border-radius: 1rem;
      animation: winline-glow 1.2s infinite alternate;
      display: block;
      pointer-events: none;
      transform: translateY(-50%);
    }

    @keyframes winline-glow {
      0% {
        box-shadow: 0 0 8px 2px gold, 0 0 16px 4px orange;
        opacity: 1;
      }
      100% {
        box-shadow: 0 0 16px 4px gold, 0 0 32px 8px orange;
        opacity: 0.9;
      }
    }
    /* Banner that appears on win */
    .win-banner {
      position: absolute;
      top: 30%;
      width: 100%;
      text-align: center;
      font-size: 2.5rem;
      color: gold;
      text-shadow: 0 0 24px gold, 0 0 48px #fff8;
      display: none;
      z-index: 20;
      font-weight: 700;
      letter-spacing: 0.1em;
      pointer-events: none;
      animation: winbanner-glow 1.2s infinite alternate;
    }
    @keyframes winbanner-glow {
      0% { text-shadow: 0 0 24px gold, 0 0 48px #fff8; }
      100% { text-shadow: 0 0 48px gold, 0 0 96px #fff8; }
    }

    /* Slot machine arch and frame styles with improved safe area handling */
    .slot-arch-frame {
      position: relative;
      margin: 2rem auto 0 auto;
      width: 44rem;
      max-width: 98vw;
      min-height: 44rem;
      background: linear-gradient(180deg, #e0e0e0 0%, #b0b0b0 100%);
      border-radius: 2.5rem 2.5rem 2rem 2rem/6rem 6rem 2rem 2rem;
      box-shadow: 0 8px 48px #000a, 0 0 0 8px #fff4 inset;
      padding: 2.5rem 2.5rem 7.5rem 2.5rem; /* more bottom padding for base */
      display: flex;
      flex-direction: column;
      align-items: center;
      z-index: 1;
      overflow: visible;
      /* Safe area adjustments for top spacing */
      margin-top: max(2rem, env(safe-area-inset-top));
    }
    .slot-arch-top {
      position: absolute;
      top: -2.5rem;
      left: 50%;
      transform: translateX(-50%);
      width: 38rem;
      height: 7rem;
      background: radial-gradient(ellipse at 50% 100%, #fff 0%, #e0e0e0 60%, #b0b0b0 100%);
      border-radius: 50% 50% 40% 40%/100% 100% 0 0;
      box-shadow: 0 2px 24px #fff8 inset, 0 8px 32px #0004;
      z-index: 2;
    }
    .slot-base {
      position: relative; /* was absolute */
      bottom: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 40rem;
      height: 4.5rem;
      background: linear-gradient(180deg, #b0b0b0 0%, #888 100%);
      border-radius: 0 0 2.5rem 2.5rem/0 0 2.5rem 2.5rem;
      box-shadow: 0 2px 24px #0008, 0 0 0 8px #fff4 inset, 0 8px 32px #0004;
      z-index: 2;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 2.2rem;
      padding: 0 2rem;
      overflow: visible;
      margin-top: 1.5rem;
      border-top: 3px solid #fff8;
    }
    @media (max-width: 700px) {
      .slot-base {
        width: 98vw;
        gap: 0.7rem;
        padding: 0 0.2rem;
      }
      .slot-arch-frame {
        padding-bottom: 8.5rem;
      }
    }
    /* Blinky lights */
    .slot-arch-lights, .slot-arch-lights-bottom {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      gap: 0.7rem;
      z-index: 10;
      pointer-events: none;
    }
    .slot-arch-lights {
      top: 0.5rem;
      width: 38rem;
      height: 2.2rem;
      justify-content: center;
      align-items: flex-end;
    }
    .slot-arch-lights-bottom {
      bottom: 7.5rem;
      width: 36rem;
      height: 2.2rem;
      justify-content: center;
      align-items: flex-start;
    }
    .slot-arch-light {
      width: 1.3rem;
      height: 1.3rem;
      border-radius: 50%;
      background: radial-gradient(circle at 60% 40%, #fff 0%, #ffd700 60%, #bfa100 100%);
      box-shadow: 0 0 16px 4px #ffd70088, 0 2px 8px #0006;
      border: 2px solid #fff8;
      opacity: 0.7;
      animation: blink 1.2s infinite;
    }
    .slot-arch-light:nth-child(2n) { background: radial-gradient(circle at 60% 40%, #fff 0%, #ff5252 60%, #b71c1c 100%); animation-delay: 0.3s; }
    .slot-arch-light:nth-child(3n) { background: radial-gradient(circle at 60% 40%, #fff 0%, #40c4ff 60%, #01579b 100%); animation-delay: 0.6s; }
    .slot-arch-light:nth-child(4n) { background: radial-gradient(circle at 60% 40%, #fff 0%, #ffd740 60%, #ffab00 100%); animation-delay: 0.9s; }
    @keyframes blink {
      0%, 100% { opacity: 0.7; filter: brightness(1); }
      50% { opacity: 1; filter: brightness(1.7); }
    }
    
    /* Enhanced lights for dynamic control */
    .slot-arch-light.on {
      opacity: 1 !important;
      filter: brightness(2) !important;
      animation: none !important;
      box-shadow: 0 0 24px 8px currentColor, 0 2px 8px #0006;
    }
    /* Enhance reel window for glassy look */
    .reels {
      background: var(--slot-bg);
      background-image: linear-gradient(180deg, #fff2 0%, #fff0 100%), repeating-linear-gradient(90deg, #fff1 0 2px, transparent 2px 12px);
      box-shadow: 0 0 64px 16px #FFD70055, 0 0 0 12px #fff2 inset, 0 8px 32px #000a, 0 0 0 8px #fff4 inset;
      border: 6px solid #bfa100;
      border-radius: var(--reel-radius);
      position: relative;
      margin-bottom: 2rem;
      overflow: visible;
    }

    .slot-arch-title-arc {
      text-align: center;
      font-size: 2.8rem;
      fill: #fff;
      stroke: #b71c1c;
      stroke-width: 2;
      letter-spacing: 0.12em;
      font-weight: 700;
      text-shadow: 0 0 16px #fff, 0 0 32px #b71c1c;
    }

    .slot-arch-emoji {
      font-size: 4rem;
      margin-top: -1.5rem;
    }

    /* Add little stickers all over the base for a playful, high-quality look */
    .slot-base-sticker.little {
      width: 1.7rem;
      height: 1.7rem;
      min-width: 1.7rem;
      min-height: 1.7rem;
      padding: 0.1rem;
      margin: 0 0.15rem;
      background: rgba(255,255,255,0.7);
      border-radius: 0.7rem;
      box-shadow: 0 1px 4px #0002, 0 0 0 1.5px #fff8 inset;
      border: 1.5px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      z-index: 3;
      transition: transform 0.12s;
    }
    .slot-base-sticker.little img {
      width: 1.2rem;
      height: 1.2rem;
      filter: drop-shadow(0 1px 2px #0003);
      margin: 0;
    }
    .slot-base-sticker.little:hover {
      transform: scale(1.2) rotate(-8deg);
      z-index: 10;
      box-shadow: 0 0 12px 2px #ffd70099, 0 2px 8px #0004;
    }

    /* Add little payout stickers for playful, high-quality look */
    .slot-payout-sticker {
      position: absolute;
      width: 2.1rem;
      height: 2.1rem;
      background: rgba(255,255,255,0.85);
      border-radius: 0.7rem;
      box-shadow: 0 1px 4px #0002, 0 0 0 1.5px #fff8 inset;
      border: 1.5px solid #e0e0e0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 10;
      padding: 0.1rem 0.2rem 0.2rem 0.2rem;
      font-size: 0.7rem;
      transition: transform 0.12s;
      cursor: pointer;
    }
    .slot-payout-sticker img {
      width: 1.3rem;
      height: 1.3rem;
      object-fit: contain;
      margin-bottom: 0.1rem;
      filter: drop-shadow(0 1px 2px #0003);
    }
    .slot-payout-sticker .payout {
      color: #b71c1c;
      font-weight: 700;
      text-shadow: 0 0 4px #fff, 0 0 8px #ffd700;
      font-size: 0.8rem;
      margin-top: -0.1rem;
    }
    .slot-payout-sticker .desc {
      color: #333;
      font-size: 0.6rem;
      font-weight: 500;
      opacity: 0.7;
      margin-bottom: 0.1rem;
      text-align: center;
    }
    .slot-payout-sticker.jackpot {
      border: 2px solid gold;
      box-shadow: 0 0 8px 1px gold, 0 1px 4px #0002;
      background: linear-gradient(180deg, #fffbe7 0%, #ffe082 100%);
    }
    .slot-payout-sticker:hover {
      transform: scale(1.18) rotate(-7deg);
      z-index: 20;
      box-shadow: 0 0 16px 2px #ffd70099, 0 2px 8px #0004;
    }

    /* Little payout stickers decorating the machine */
    .slot-payout-sticker.little {
      width: 1.7rem;
      height: 1.7rem;
      min-width: 1.7rem;
      min-height: 1.7rem;
      padding: 0.1rem;
      margin: 0 0.15rem;
      background: rgba(255,255,255,0.7);
      border-radius: 0.7rem;
      box-shadow: 0 1px 4px #0002, 0 0 0 1.5px #fff8 inset;
      border: 1.5px solid #e0e0e0;
      display: flex;
      align-items: center;
      justify-content: center;
      position: absolute;
      z-index: 3;
      transition: transform 0.12s;
    }
    .slot-payout-sticker.little img {
      width: 1.2rem;
      height: 1.2rem;
      filter: drop-shadow(0 1px 2px #0003);
      margin: 0;
    }
    .slot-payout-sticker.little:hover {
      transform: scale(1.2) rotate(-8deg);
      z-index: 10;
      box-shadow: 0 0 12px 2px #ffd70099, 0 2px 8px #0004;
    }

    .pay-table {
      margin: 1.2rem auto 0 auto;
      display: flex;
      flex-direction: column;
      justify-content: flex-start;
      gap: 0.3rem;
      background: var(--paytable-bg);
      color: var(--paytable-color);
      box-shadow: 0 2px 8px #0002, 0 0 0 2px #fff8 inset;
      padding: 0.5rem 0.7rem;
      max-width: 98vw;
      font-size: 0.98rem;
      align-items: flex-start;
      width: 100%;
      min-width: 0;
    }
    .pay-row {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      font-weight: 600;
      color: inherit;
      letter-spacing: 0.04em;
      margin: 0 0.1rem;
      flex-wrap: wrap;
    }
    .pay-symbol {
      width: 1.3rem;
      height: 1.3rem;
      object-fit: contain;
      filter: drop-shadow(0 1px 2px #0003);
      border-radius: 0.3rem;
      background: #fff;
      margin-right: 0.1rem;
      flex-shrink: 0;
    }
    .pay-label {
      color: inherit;
      font-size: 0.98rem;
      font-weight: 500;
      margin-right: 0.1rem;
      white-space: nowrap;
    }
    .pay-mult {
      color: #bfa100;
      font-size: 1rem;
      font-weight: 700;
      margin-left: 0.1rem;
      text-shadow: 0 0 4px #fff, 0 0 8px #ffd700;
      white-space: nowrap;
    }
    body:not(.light) .pay-mult {
      color: #e53935;
      text-shadow: 0 0 4px #fff, 0 0 8px #e53935;
    }
    @media (max-width: 600px) {
      .pay-table {
        padding: 0.4rem 0.2rem;
        font-size: 0.92rem;
      }
      .pay-symbol {
        width: 1.1rem;
        height: 1.1rem;
      }
      .pay-label, .pay-mult {
        font-size: 0.92rem;
      }
    }

    </style>
</head>
<body>
  <!-- Sound effects for spinning, stopping, and winning -->
  <audio id="spin-sound" src="sounds/spin.wav"></audio>
  <audio id="stop-sound" src="sounds/stop.wav"></audio>
  <audio id="win-sound" src="sounds/win.wav"></audio>
  <audio id="lose-sound" src="sounds/lose.wav"></audio>

  <div class="slot-arch-frame">
    <div class="slot-arch-lights"></div>
    <div class="slot-arch-top">
      <div class="slot-arch-title-arc">
        <svg viewBox="0 0 700 120" width="100%" height="80" style="display:block;">
          <path id="arcPath" d="M 60 100 Q 350 10 640 100" fill="transparent" stroke="none"/>
          <text width="100%">
            <textPath href="#arcPath" startOffset="50%" text-anchor="middle" dominant-baseline="middle" style="font-size:2.8rem;fill:#fff;stroke:#b71c1c;stroke-width:2;letter-spacing:0.12em;font-weight:700;text-shadow:0 0 16px #fff,0 0 32px #b71c1c;">
              OctoSlots
            </textPath>
          </text>
        </svg>
        <div class="slot-arch-emoji" style="margin-bottom:0.2rem;">ðŸŽ°</div>
      </div>
    </div>
    <div class="container">
</style>
<style>

    @media (max-width: 450px) and (min-height: 800px) {
      html, body {
        min-height: 100dvh;
        height: 100dvh;
        background: var(--bg-gradient);
        padding-top: env(safe-area-inset-top);
        padding-bottom: env(safe-area-inset-bottom);
        margin: 0;
        box-sizing: border-box;
        display: flex;
        justify-content: center;
        align-items: center;
      }
      .toggle-mode-bar {
        padding-top: max(env(safe-area-inset-top), 0.7rem);
        padding-bottom: 0.3rem;
      }
      .slot-arch-frame {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
        min-height: unset !important;
      }
      .container {
        padding-bottom: 0 !important;
        margin-bottom: 0 !important;
      }
      .controls {
        margin-bottom: 0.2rem !important;
        margin-top: 0.7rem !important;
      }
      .pay-table {
        margin-bottom: 0.1rem !important;
      }
      body {
        background: var(--bg-gradient);
      }
    }
  /* iPhone 16 Pro Max and modern iPhones: safe area and bottom fix */
  @media (max-width: 450px) and (min-height: 800px) {
    html, body {
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
      background: var(--bg-gradient);
      display: flex;
      justify-content: center;
      align-items: center;
    }
    .slot-arch-frame {
      padding-bottom: 2.5rem !important;
    }
    .controls {
      margin-bottom: 0.5rem !important;
      margin-top: 0.7rem !important;
    }
    .pay-table {
      margin-bottom: 0.2rem !important;
    }
  }
</style>
      <!-- Win line and banner, shown when you win -->
      <div class="reels" style="position: relative;">
        <div class="win-line" id="win-line"></div>
        <div class="reel" id="reel1"><div class="reel-strip"></div></div>
        <div class="reel" id="reel2"><div class="reel-strip"></div></div>
        <div class="reel" id="reel3"><div class="reel-strip"></div></div>
      </div>
      <div class="slot-arch-lights slot-arch-lights-bottom"></div>
      <div class="win-banner" id="win-banner">ðŸŽ‰ WINNER! ðŸŽ‰</div>
      <!-- Spin button -->
      <div class="controls">
        <button class="spin" id="spin-btn" onclick="spin()">SPIN</button>
      </div>
      <!-- Player credits and last win display -->
      <div class="jackpot">
        Credits: <span id="credits">1000</span> &nbsp;|&nbsp; Last Win: <span id="last-win">0</span>
        <span id="last-win-symbols" style="display:inline-block; vertical-align:middle; margin-left:10px;"></span>
      </div>
      <!-- Pay table below credits/last win -->
      <div class="pay-table">
        <div class="pay-row">
          <img src="images/original.png" alt="Original Octocat" class="pay-symbol" />
          <span class="pay-label">3 Originals (JACKPOT)</span>
          <span class="pay-mult">x100</span>
        </div>
        <div class="pay-row">
          <img src="images/daftpunktocat-guy.gif" alt="Daftpunktocat" class="pay-symbol" />
          <span class="pay-label">3 Daftpunktocat</span>
          <span class="pay-mult">x50</span>
        </div>
        <div class="pay-row">
          <img src="images/surftocat.png" alt="Other Octocats" class="pay-symbol" />
          <span class="pay-label">3 of any other</span>
          <span class="pay-mult">x10</span>
        </div>
        <div class="pay-row">
          <img src="images/original.png" alt="Any Octocat" class="pay-symbol" />
          <span class="pay-label">2 of any</span>
          <span class="pay-mult">x5</span>
        </div>
      </div>
      
      <!-- Light/Dark mode toggle button and Reel Color Customization -->
      <div class="toggle-mode-footer">
        <div class="color-customization">
          <label for="reel-color-picker" class="color-label">Reel Color:</label>
          <input type="color" id="reel-color-picker" class="color-picker" value="#f8f4e6" title="Choose reel color">
        </div>
        <button class="toggle-mode" onclick="toggleMode()">ðŸŒ™</button>
      </div>
    </div>
  </div>

  <!-- Main game logic -->
  <script>
    // Fill all reels on page load to prevent blanks
    window.addEventListener('DOMContentLoaded', () => {
      [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')].forEach(reel => fillReel(reel));
    });
    // List of symbol image URLs for the reels
    const rawSymbols = [
      'images/original.png',
      'images/surftocat.png',
      'images/yogitocat.png',
      'images/boxertocat_octodex.png',
      'images/dinotocat.png',
      'images/plumber.png',
      'images/securitocat.png',
      'images/inspectocat.png',
      'images/daftpunktocat-guy.gif',
      'images/minion.png',
      'images/droidtocat.png',
      'images/ironcat.png',
      'images/topguntocat.png',
      'images/megacat.png',
      'images/repo.png',
      'images/spidertocat.png',
      'images/vinyltocat.png',
      'images/octobiwan.png',
      'images/boxertocat_octodex.png',
      'images/megacat.png'
    ];

    // Filter out any empty, null, or undefined symbols to prevent blank spaces
    const symbols = rawSymbols.filter(symbol => 
      symbol && 
      typeof symbol === 'string' && 
      symbol.trim().length > 0
    );

    // Function to get a valid random symbol (never returns empty)
    function getValidRandomSymbol() {
      if (symbols.length === 0) {
        // Fallback to original if no valid symbols (should never happen)
        return 'images/original.png';
      }
      return symbols[Math.floor(Math.random() * symbols.length)];
    }

    // Get audio elements for sound effects
    const spinSound = document.getElementById('spin-sound');
    const stopSound = document.getElementById('stop-sound');
    const winSound = document.getElementById('win-sound');

    // Fill a reel with random symbols. Optionally, stop at a specific symbol index.
    function fillReel(reel, stopAt = null) {
      const strip = reel.querySelector('.reel-strip');
      strip.innerHTML = '';
      // Add 40 random symbols to the reel (prevents animation blanks)
      const reelSymbols = [];
      for (let i = 0; i < 40; i++) {
        const sym = document.createElement('div');
        sym.className = 'symbol';
        const img = document.createElement('img');
        
        // Pick a valid random symbol from the filtered list
        const symbol = getValidRandomSymbol();
        
        // Only proceed if we have a valid symbol
        if (symbol && symbol.trim().length > 0) {
          img.src = symbol;
          img.alt = 'Octocat Symbol';
          
          // Enhanced fallback handling with multiple levels of error recovery
          img.onerror = function() {
            console.log('Image failed to load:', this.src, 'Applying fallback strategy.');
            this.onerror = null; // Prevent infinite loops
            
            // Try fallback to original image first
            if (this.src !== 'images/original.png') {
              this.src = 'images/original.png';
              // Set up secondary fallback
              this.onerror = function() {
                console.log('Original fallback also failed, using SVG placeholder.');
                this.onerror = null;
                // Final fallback: use a styled SVG placeholder that matches game aesthetic
                this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23FFD700;stop-opacity:1" /><stop offset="100%" style="stop-color:%23FFA500;stop-opacity:1" /></linearGradient></defs><rect width="100%" height="100%" fill="url(%23grad)" rx="8"/><circle cx="40" cy="30" r="8" fill="white"/><path d="M 25 45 Q 40 60 55 45" stroke="white" stroke-width="3" fill="none"/><text x="50%" y="75%" font-size="8" text-anchor="middle" fill="white" font-family="Arial">OCTO</text></svg>';
              };
            } else {
              // Already tried original, go straight to SVG
              this.src = 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="80" height="80" viewBox="0 0 80 80"><defs><linearGradient id="grad" x1="0%" y1="0%" x2="100%" y2="100%"><stop offset="0%" style="stop-color:%23FFD700;stop-opacity:1" /><stop offset="100%" style="stop-color:%23FFA500;stop-opacity:1" /></linearGradient></defs><rect width="100%" height="100%" fill="url(%23grad)" rx="8"/><circle cx="40" cy="30" r="8" fill="white"/><path d="M 25 45 Q 40 60 55 45" stroke="white" stroke-width="3" fill="none"/><text x="50%" y="75%" font-size="8" text-anchor="middle" fill="white" font-family="Arial">OCTO</text></svg>';
            }
          };
          
          sym.appendChild(img);
          strip.appendChild(sym);
          reelSymbols.push(sym.cloneNode(true));
        }
      }
      
      // Ensure we have symbols (safety check)
      if (reelSymbols.length === 0) {
        console.warn('No valid symbols could be created, adding fallback symbol');
        const fallbackSym = document.createElement('div');
        fallbackSym.className = 'symbol';
        const fallbackImg = document.createElement('img');
        fallbackImg.src = 'images/original.png';
        fallbackImg.alt = 'Fallback Octocat';
        fallbackSym.appendChild(fallbackImg);
        strip.appendChild(fallbackSym);
        reelSymbols.push(fallbackSym.cloneNode(true));
      }
      
      // Duplicate the first 3 symbols at the end for seamless looping
      for (let i = 0; i < Math.min(3, reelSymbols.length); i++) {
        strip.appendChild(reelSymbols[i].cloneNode(true));
      }

      // If a stop position is given, set the strip position so the chosen symbol is centered
      if (stopAt !== null) {
        // Center the symbol in the viewing window (same logic as animateToStop)  
        const centeredPosition = stopAt * 128 - 64; // Updated for 8rem symbols with no gaps
        strip.style.transform = `translateY(${-centeredPosition}px)`;
      }
    }

    // Enhanced 4K reel animation with improved physics
function animateReel(reel, spinTime, stopAt, reelIndex, onStopPhaseStart) {
  return new Promise(resolve => {
        const strip = reel.querySelector('.reel-strip');
        reel.classList.add('spinning');
        
        let spinning = true;
        let startTime = null;
        let lastY = 0;
        let frame;
        const totalSymbols = 43; // 40 + 3 duplicates for seamless loop
        const symbolHeight = 128; // Enhanced for 4K: 8rem = 128px
        
        // Enhanced spinning with acceleration and blur
        strip.style.filter = 'blur(3px)';
        strip.style.transition = 'filter 0.3s ease-out';
        
    function spinLoop(ts) {
      if (!startTime) startTime = ts;
      const elapsed = ts - startTime;
      
      if (elapsed < spinTime) {
        // Improved animation with easing
        const progress = elapsed / spinTime;
        const easeOut = 1 - Math.pow(1 - progress, 3);
        const speed = 3 + (2 * (1 - easeOut)); // Start fast, slow down
        
        // Calculate continuous position to prevent black flashing
        const rawY = elapsed * speed;
        lastY = rawY % (totalSymbols * symbolHeight);
        // Ensure smooth continuous motion without jumps
        strip.style.transform = `translateY(${-lastY}px)`;
        frame = requestAnimationFrame(spinLoop);
      } else {
        spinning = false;
        reel.classList.remove('spinning');
        // Calculate stopping position
        let modY = ((lastY % (totalSymbols * symbolHeight)) + (totalSymbols * symbolHeight)) % (totalSymbols * symbolHeight);
        animateToStop(modY, stopAt, onStopPhaseStart);
      }
    }
        
        function animateToStop(currentModY, stopAt, onStopPhaseStart) {
          const targetY = stopAt * symbolHeight - (symbolHeight / 2); // Perfect center for symbols with no gaps
          let forwardDistance = (targetY - currentModY + totalSymbols * symbolHeight) % (totalSymbols * symbolHeight);
          // Call the callback at the exact moment the stop phase starts
          if (typeof onStopPhaseStart === 'function') {
            onStopPhaseStart();
          }
          const duration = 800; // Slightly longer for smoother stop
          let animStart = null;
          function animStep(ts) {
            if (!animStart) animStart = ts;
            const progress = Math.min((ts - animStart) / duration, 1);
            // Smooth easing for stopping
            const easeOut = 1 - Math.pow(1 - progress, 4);
            const y = currentModY + easeOut * forwardDistance;
            const modY = ((y % (totalSymbols * symbolHeight)) + (totalSymbols * symbolHeight)) % (totalSymbols * symbolHeight);
            strip.style.transform = `translateY(${-modY}px)`;
            // Gradually remove blur as it slows down
            const blurAmount = 3 * (1 - progress);
            strip.style.filter = `blur(${blurAmount}px)`;
            if (progress < 1) {
              requestAnimationFrame(animStep);
            } else {
              strip.style.transform = `translateY(${-targetY}px)`;
              strip.style.filter = 'none';
              // Preserve visual continuity - no forced redraw
              resolve();
            }
          }
          requestAnimationFrame(animStep);
        }
        
        requestAnimationFrame(spinLoop);
      });
    }

    // Show sparkles on win
    function sparkleEffect() {
      // Create 15 sparkles at random positions
      for (let i = 0; i < 15; i++) {
        const s = document.createElement('div');
        s.className = 'sparkle';
        s.style.left = `${Math.random() * window.innerWidth}px`;
        s.style.top = `${Math.random() * 400 + 100}px`;
        document.body.appendChild(s);
        // Remove the sparkle after 1 second
        setTimeout(() => s.remove(), 1000);
      }
    }

    // Main function to spin the reels
    // Track player credits and last win
    let credits = 1000;
    let lastWin = 0;
    const betAmount = 100;

    // Flashing lights animation
    let lightInterval = null;
    function startLights(winning = false) {
      if (lightInterval) clearInterval(lightInterval);
      
      const lights = document.querySelectorAll('.slot-arch-light');
      lights.forEach(light => light.classList.remove('on'));
      
      let idx = 0;
      lightInterval = setInterval(() => {
        lights.forEach((light, i) => {
          if (winning) {
            // Random flashing for winning
            light.classList.toggle('on', Math.random() > 0.5);
          } else {
            // Sequential flashing for spinning
            light.classList.toggle('on', i === idx % lights.length);
          }
        });
        idx++;
      }, 100);
    }
    
    function stopLights() {
      if (lightInterval) clearInterval(lightInterval);
      const lights = document.querySelectorAll('.slot-arch-light');
      lights.forEach(light => light.classList.remove('on'));
    }

    function updateDisplay() {
      document.getElementById('credits').textContent = credits;
      document.getElementById('last-win').textContent = lastWin;
    }

    async function spin() {
      // Hide win popup if visible
      document.getElementById('win-banner').style.display = 'none';
      
      // Stop any previous light effects
      stopLights();

      // Prevent spinning if not enough credits
      if (credits < betAmount) {
        alert('Not enough credits!');
        return;
      }
      // Disable spin button during spin
      document.getElementById('spin-btn').disabled = true;

      // Start flashing lights to indicate spinning
      startLights();

      // Deduct bet
      credits -= betAmount;
      updateDisplay();

      // Play the spin sound
      spinSound.play();

      // Get all three reels
      const reels = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
      // Pick a random stop position for each reel (symbol indices 0-19)
      const stops = reels.map(() => Math.floor(Math.random() * 20));
      // Fill each reel with random symbols
      reels.forEach((reel, index) => fillReel(reel)); // preload strips

      // Start all reels spinning at the same time, but stop them individually
      // Enhanced 4K spinning effects
      reels.forEach(reel => {
        reel.classList.add('spinning');
        reel.style.willChange = 'transform';
      });

      const spinTimes = [1800, 2300, 2800];

      // REVERT: Use original logic (no onStopPhaseStart, no setTimeout for spinSound)
      const reelPromises = reels.map((reel, i) => animateReel(reel, spinTimes[i], stops[i]));
      for (let i = 0; i < reelPromises.length; i++) {
        await reelPromises[i];
        // Play stop sound for first 2 reels (overlaps with spin sound)
        if (i < 2) {
          const stopClone = stopSound.cloneNode();
          stopClone.currentTime = 0;
          stopClone.play();
        }
        // On the 3rd (final) reel, stop spin sound and play final stop sound
        if (i === 2) {
          spinSound.pause();
          spinSound.currentTime = 0;
          stopSound.currentTime = 0;
          stopSound.play();
        }
      }
      
      // Remove spinning effects after all reels stop
      reels.forEach(reel => {
        reel.classList.remove('spinning');
        reel.style.willChange = 'auto';
      });
      // Wait for stop.wav to start before win/lose logic
      await new Promise(resolve => setTimeout(resolve, 350));

      // Re-enable spin button after sounds finish
      document.getElementById('spin-btn').disabled = false;

      // --- WIN LOGIC ---
      // Only consider the center row (middle symbol) of each reel
      // Get the center index for each reel
      const reelsArr = [document.getElementById('reel1'), document.getElementById('reel2'), document.getElementById('reel3')];
      const totalSymbols = 20;
      const symbolHeight = 128; // Match CSS --symbol-size: 8rem (8 * 16px = 128px)
      function getCenterSymbolSrc(reel) {
        const reelRect = reel.getBoundingClientRect();
        const centerY = reelRect.top + reelRect.height / 2;
        const symbols = Array.from(reel.querySelectorAll('.symbol'));
        for (let symbolDiv of symbols) {
          const rect = symbolDiv.getBoundingClientRect();
          if (rect.top <= centerY && rect.bottom >= centerY) {
            const img = symbolDiv.querySelector('img');
            // Return empty string only if img is missing or src is invalid
            const src = img ? img.src : '';
            // Filter out data URIs (SVG fallbacks) and empty sources for win calculation
            if (src && !src.startsWith('data:')) {
              return src;
            }
          }
        }
        return '';
      }
      
      function getCenterSymbolElement(reel) {
        const reelRect = reel.getBoundingClientRect();
        const centerY = reelRect.top + reelRect.height / 2;
        const symbols = Array.from(reel.querySelectorAll('.symbol'));
        for (let symbolDiv of symbols) {
          const rect = symbolDiv.getBoundingClientRect();
          if (rect.top <= centerY && rect.bottom >= centerY) {
            return symbolDiv;
          }
        }
        return null;
      }
      // Get the three center symbols by DOM position
      const symbolsLanded = reelsArr.map(reel => getCenterSymbolSrc(reel));
      // Filter out empty or invalid symbols before counting
      const validSymbolsLanded = symbolsLanded.filter(src => src && src.trim().length > 0);
      // Count occurrences of each valid symbol in the center row
      const counts = {};
      validSymbolsLanded.forEach(src => { counts[src] = (counts[src] || 0) + 1; });
      let winType = null;
      let winSymbol = null;
      let payout = 0;
      let jackpotSymbols = [
        'https://bensbar.github.io/OctoSlots/images/daftpunktocat-guy.gif',
        'https://bensbar.github.io/OctoSlots/images/original.png'
      ];
      // Find the actual max count and its symbol
      let maxCount = 0;
      let maxSymbol = null;
      for (let src in counts) {
        if (counts[src] > maxCount) {
          maxCount = counts[src];
          maxSymbol = src;
        }
      }
      // Check for 3 of a kind (jackpot or normal)
      if (maxCount === 3) {
        winType = jackpotSymbols.includes(maxSymbol) ? 'jackpot' : 'three';
        winSymbol = maxSymbol;
      } else if (maxCount === 2) {
        winType = 'two';
        winSymbol = maxSymbol;
      }
      // Set payout
      if (winType === 'jackpot') {
        payout = 100 * betAmount;
      } else if (winType === 'three') {
        payout = 10 * betAmount;
      } else if (winType === 'two') {
        payout = 2 * betAmount;
      }

      // Show win if any
      const lastWinSymbols = document.getElementById('last-win-symbols');
      lastWinSymbols.innerHTML = '';
      if (winType) {
        lastWin = payout;
        credits += lastWin;
        updateDisplay();
        // Show small octocats for the win - only show valid symbols
        for (let i = 0; i < 3; i++) {
          if (symbolsLanded[i] === winSymbol && symbolsLanded[i] && symbolsLanded[i].trim().length > 0) {
            const img = document.createElement('img');
            img.src = winSymbol;
            img.alt = 'Winning Symbol';
            img.style.width = '32px';
            img.style.height = '32px';
            img.style.margin = '0 2px';
            img.style.verticalAlign = 'middle';
            // Add error handling for win display images too
            img.onerror = function() {
              this.onerror = null;
              this.src = 'images/original.png';
            };
            lastWinSymbols.appendChild(img);
          }
        }
        const winBanner = document.getElementById('win-banner');
        winBanner.textContent = winType === 'jackpot' ? 'ðŸŽ‰ JACKPOT! ðŸŽ‰' : (winType === 'three' ? 'ðŸŽ‰ BIG WIN! ðŸŽ‰' : 'WIN!');
        winBanner.style.display = 'block';
        
        // Play win sound after stop sound
        winSound.currentTime = 0;
        winSound.play();
        
        // Enhanced 4K particle effects and celebration
        sparkleEffect();
        triggerWinCelebration(payout);
        
        // Add winning symbol highlighting
        const reelElements = document.querySelectorAll('.reel');
        reelElements.forEach(reel => {
          const centerSymbol = getCenterSymbolElement(reel);
          if (centerSymbol && centerSymbol.querySelector('img').src === winSymbol) {
            centerSymbol.classList.add('winning');
          }
        });
        
        // Start winning lights animation
        startLights(true);
        setTimeout(() => {
          winBanner.style.display = 'none';
          // Remove winning highlights
          document.querySelectorAll('.symbol.winning').forEach(symbol => {
            symbol.classList.remove('winning');
          });
        }, 3000);
      } else {
        lastWin = 0;
        updateDisplay();
        lastWinSymbols.innerHTML = '';
        
        // Play lose sound after stop sound
        const loseSound = document.getElementById('lose-sound');
        if (loseSound) {
          loseSound.currentTime = 0;
          loseSound.play();
        }
        
        // Stop lights on lose
        stopLights();
      }
    }

    // Toggle between light and dark mode
    function toggleMode() {
      document.body.classList.toggle('light');
      const toggleButton = document.querySelector('.toggle-mode');
      if (document.body.classList.contains('light')) {
        toggleButton.textContent = 'ðŸŒž';
      } else {
        toggleButton.textContent = 'ðŸŒ™';
      }
      
      // Update reel colors when mode changes
      const colorPicker = document.getElementById('reel-color-picker');
      if (colorPicker && colorPicker.value) {
        updateReelColors(colorPicker.value);
      }
    }

    // Hide win popup when clicking spin or the popup itself
    document.addEventListener('DOMContentLoaded', () => {
      const winBanner = document.getElementById('win-banner');
      winBanner.addEventListener('click', () => {
        winBanner.style.display = 'none';
      });
      document.getElementById('spin-btn').addEventListener('click', () => {
        winBanner.style.display = 'none';
      });
    });

    // When the page loads, fill each reel with random symbols and update display
    window.onload = () => {
      fillReel(document.getElementById('reel1'), Math.floor(Math.random() * 20));
      fillReel(document.getElementById('reel2'), Math.floor(Math.random() * 20));
      fillReel(document.getElementById('reel3'), Math.floor(Math.random() * 20));
      updateDisplay();
      // Add slot machine handle
      const handle = document.createElement('div');
      handle.className = 'slot-handle';
      const knob = document.createElement('div');
      knob.className = 'slot-handle-knob';
      handle.appendChild(knob);
      document.querySelector('.reels').appendChild(handle);

      // Handle lever pull interaction
      let pulling = false;
      knob.addEventListener('mousedown', () => {
        if (pulling) return;
        pulling = true;
        handle.classList.add('pulled');
      });
      document.addEventListener('mouseup', () => {
        if (!pulling) return;
        handle.classList.remove('pulled');
        setTimeout(() => {
          document.getElementById('spin-btn').click();
          pulling = false;
        }, 150); // short delay for lever animation
      });

      // Add blinky lights to the arch (top and bottom)
      function addArchLights(selector, count) {
        const lightsContainer = document.querySelector(selector);
        if (lightsContainer) {
          lightsContainer.innerHTML = '';
          for (let i = 0; i < count; i++) {
            const light = document.createElement('div');
            light.className = 'slot-arch-light';
            lightsContainer.appendChild(light);
          }
        }
      }
      document.addEventListener('DOMContentLoaded', () => {
        addArchLights('.slot-arch-lights', 22);
        addArchLights('.slot-arch-lights-bottom', 18);
      });
    };

    // Enhanced 4K Particle Effects System
    function createParticleEffect(centerX, centerY, particleCount = 15, effectType = 'sparkle') {
      const particleTypes = ['sparkle', 'star', 'gold', 'diamond'];
      const colors = ['#FFD700', '#FFA500', '#FF8C00', '#FFFF00', '#00FF00'];
      
      for (let i = 0; i < particleCount; i++) {
        setTimeout(() => {
          const particle = document.createElement('div');
          particle.className = `particle-4k ${effectType}`;
          
          // Random position around center
          const angle = (Math.PI * 2 * i) / particleCount + Math.random() * 0.5;
          const distance = 50 + Math.random() * 100;
          const startX = centerX + Math.cos(angle) * (distance * 0.1);
          const startY = centerY + Math.sin(angle) * (distance * 0.1);
          const endX = centerX + Math.cos(angle) * distance;
          const endY = centerY + Math.sin(angle) * distance;
          
          particle.style.cssText = `
            position: fixed;
            left: ${startX}px;
            top: ${startY}px;
            width: ${4 + Math.random() * 8}px;
            height: ${4 + Math.random() * 8}px;
            background: radial-gradient(circle, ${colors[Math.floor(Math.random() * colors.length)]} 0%, transparent 70%);
            border-radius: 50%;
            pointer-events: none;
            z-index: 1000;
            animation: particle-float-4k ${2 + Math.random() * 2}s ease-out forwards;
            --end-x: ${endX}px;
            --end-y: ${endY}px;
            --rotation: ${Math.random() * 720}deg;
            transform: translateZ(0);
            will-change: transform, opacity;
          `;
          
          document.body.appendChild(particle);
          
          // Remove particle after animation
          setTimeout(() => {
            if (particle.parentNode) {
              particle.parentNode.removeChild(particle);
            }
          }, 4000);
        }, i * 50);
      }
    }

    // Enhanced win celebration with 4K effects
    function triggerWinCelebration(winAmount) {
      const slotMachine = document.querySelector('.slot-base');
      const rect = slotMachine.getBoundingClientRect();
      const centerX = rect.left + rect.width / 2;
      const centerY = rect.top + rect.height / 2;
      
      // Create multiple particle bursts
      createParticleEffect(centerX, centerY, 20, 'sparkle');
      setTimeout(() => createParticleEffect(centerX - 50, centerY - 50, 15, 'star'), 300);
      setTimeout(() => createParticleEffect(centerX + 50, centerY - 50, 15, 'gold'), 600);
      setTimeout(() => createParticleEffect(centerX, centerY + 50, 12, 'diamond'), 900);
      
      // Enhanced light show
      startLights(true);
      setTimeout(() => {
        stopLights();
        startLights(true);
      }, 1000);
      setTimeout(() => stopLights(), 3000);
      
      // Screen flash effect for big wins
      if (winAmount >= 500) {
        const flash = document.createElement('div');
        flash.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100vw;
          height: 100vh;
          background: radial-gradient(circle, rgba(255,215,0,0.3) 0%, transparent 70%);
          pointer-events: none;
          z-index: 999;
          animation: flash-4k 0.5s ease-out forwards;
        `;
        document.body.appendChild(flash);
        setTimeout(() => {
          if (flash.parentNode) {
            flash.parentNode.removeChild(flash);
          }
        }, 500);
      }
    }

    // Enhanced iOS optimization and orientation handling
    function initializeIOSOptimizations() {
      // iOS viewport height fix
      const setVH = () => {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
      };
      
      setVH();
      window.addEventListener('resize', setVH);
      window.addEventListener('orientationchange', () => {
        setTimeout(setVH, 100);
      });
      
      // iOS-specific touch handling
      document.addEventListener('touchstart', function() {}, { passive: true });
      document.addEventListener('touchmove', function(e) {
        // Prevent scrolling on game area
        if (e.target.closest('.slot-arch-frame')) {
          e.preventDefault();
        }
      }, { passive: false });
      
      // Hardware acceleration for smooth animations
      const acceleratedElements = document.querySelectorAll('.reel, .symbol, button, .slot-arch-frame');
      acceleratedElements.forEach(element => {
        element.style.transform = 'translateZ(0)';
        element.style.backfaceVisibility = 'hidden';
        element.style.webkitBackfaceVisibility = 'hidden';
      });
    }

    // Enhanced animation system with 4K effects
    function enhanceAnimations() {
      // Add CSS for 4K particle animations
      const style = document.createElement('style');
      style.textContent = `
        @keyframes particle-float-4k {
          0% {
            transform: translate(0, 0) scale(0) rotate(0deg);
            opacity: 0;
          }
          10% {
            opacity: 1;
          }
          90% {
            opacity: 1;
          }
          100% {
            transform: translate(calc(var(--end-x) - 50vw), calc(var(--end-y) - 50vh)) scale(1.5) rotate(var(--rotation));
            opacity: 0;
          }
        }
        
        @keyframes flash-4k {
          0% { opacity: 0; }
          50% { opacity: 1; }
          100% { opacity: 0; }
        }
        
        /* Enhanced 4K reel spinning effects */
        .reel.spinning {
          animation: reel-glow-4k 0.5s ease-in-out infinite alternate;
        }
        
        @keyframes reel-glow-4k {
          0% {
            box-shadow: 
              0 4px 20px rgba(0,0,0,0.3),
              0 0 0 2px rgba(255,215,0,0.2),
              inset 0 0 20px rgba(255,255,255,0.1);
          }
          100% {
            box-shadow: 
              0 4px 20px rgba(0,0,0,0.3),
              0 0 0 2px rgba(255,215,0,0.6),
              inset 0 0 20px rgba(255,255,255,0.3),
              0 0 30px rgba(255,215,0,0.4);
          }
        }
        
        /* Enhanced symbol highlighting */
        .symbol.winning {
          animation: symbol-pulse-4k 1s ease-in-out infinite alternate;
        }
        
        @keyframes symbol-pulse-4k {
          0% {
            transform: scale(1.05);
            box-shadow: 0 0 10px rgba(255,215,0,0.5);
          }
          100% {
            transform: scale(1.15);
            box-shadow: 0 0 20px rgba(255,215,0,0.8);
          }
        }
        
        /* Enhanced button interactions */
        button.spin {
          transition: all 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        button.spin:active {
          transform: translateY(2px) scale(0.98);
        }
        
        /* 4K optimizations for high-DPI displays */
        @media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
          .symbol img {
            image-rendering: -webkit-optimize-contrast;
            image-rendering: optimize-contrast;
            image-rendering: crisp-edges;
          }
          
          .slot-arch-frame {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
          }
        }
      `;
      document.head.appendChild(style);
    }

    // Initialize all enhancements
    document.addEventListener('DOMContentLoaded', () => {
      initializeIOSOptimizations();
      enhanceAnimations();
      initializeColorCustomization();
      
      // Add iPhone-specific CSS file
      const iPhoneCSS = document.createElement('link');
      iPhoneCSS.rel = 'stylesheet';
      iPhoneCSS.href = 'iphone_media_query.css';
      document.head.appendChild(iPhoneCSS);
    });

    // Reel Color Customization System
    function initializeColorCustomization() {
      const colorPicker = document.getElementById('reel-color-picker');
      
      // Load saved color from localStorage
      const savedColor = localStorage.getItem('octoslots-reel-color');
      if (savedColor) {
        colorPicker.value = savedColor;
        updateReelColors(savedColor);
      }
      
      // Handle color changes
      colorPicker.addEventListener('input', (e) => {
        const newColor = e.target.value;
        updateReelColors(newColor);
        localStorage.setItem('octoslots-reel-color', newColor);
      });
      
      // Also handle change event for better browser compatibility
      colorPicker.addEventListener('change', (e) => {
        const newColor = e.target.value;
        updateReelColors(newColor);
        localStorage.setItem('octoslots-reel-color', newColor);
      });
    }
    
    function updateReelColors(hexColor) {
      // Convert hex to RGB for gradient generation
      const r = parseInt(hexColor.slice(1, 3), 16);
      const g = parseInt(hexColor.slice(3, 5), 16);
      const b = parseInt(hexColor.slice(5, 7), 16);
      
      // Create lighter and darker variants for gradient
      const lighter = `rgb(${Math.min(255, r + 40)}, ${Math.min(255, g + 40)}, ${Math.min(255, b + 40)})`;
      const darker = `rgb(${Math.max(0, r - 40)}, ${Math.max(0, g - 40)}, ${Math.max(0, b - 40)})`;
      const veryDark = `rgb(${Math.max(0, r - 60)}, ${Math.max(0, g - 60)}, ${Math.max(0, b - 60)})`;
      
      // Update CSS variables
      const root = document.documentElement;
      const newGradient = `linear-gradient(145deg, ${lighter} 0%, ${hexColor} 50%, ${darker} 100%)`;
      
      // Update both slot background and reel drum with the new color prominently
      root.style.setProperty('--slot-bg', newGradient);
      
      // Update reel drum background for both light and dark modes with more prominent colors
      const isLightMode = document.body.classList.contains('light');
      
      if (isLightMode) {
        // Light mode reel drum - make the color more prominent
        const drumGradient = `linear-gradient(180deg, ${lighter} 0%, ${hexColor} 30%, ${hexColor} 70%, ${darker} 100%), 
                             radial-gradient(ellipse at 50% 30%, rgba(255, 215, 0, 0.1) 0%, transparent 70%), 
                             ${newGradient}`;
        root.style.setProperty('--reel-drum', drumGradient);
      } else {
        // Dark mode reel drum - make the color more prominent
        const drumGradient = `linear-gradient(180deg, ${hexColor} 0%, ${darker} 30%, ${veryDark} 70%, ${darker} 100%), 
                             radial-gradient(ellipse at 50% 30%, rgba(255, 215, 0, 0.2) 0%, transparent 70%), 
                             ${newGradient}`;
        root.style.setProperty('--reel-drum', drumGradient);
      }
      
      // Also update the reels container background to make color change more visible
      const reelsBackground = `linear-gradient(180deg, ${lighter} 0%, ${hexColor} 50%, ${darker} 100%)`;
      root.style.setProperty('--reels-bg', reelsBackground);
    }
  </script>

</body></html>